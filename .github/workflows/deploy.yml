name: Production Pipeline (CI/CD)

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # --- PHASE 1: PREPARATION & TESTING (Runs on PR & Merge) ---
    - name: Checkout code
      uses: actions/checkout@v3

    # We run tests on Master too! You don't want to deploy if tests fail.
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Make mvnw executable
      run: chmod +x mvnw

    # ðŸ›‘ STOP HERE if the code is broken
    - name: Run Unit Tests
      run: ./mvnw clean test

    # --- PHASE 2: DOCKER SETUP (Runs on PR & Merge) ---
    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DO_ACCESS_TOKEN }}

    - name: Log in to DigitalOcean Container Registry
      run: doctl registry login --expiry-seconds 600

    # We build the image to verify the Dockerfile is valid.
    - name: Build container image
      run: docker build -t registry.digitalocean.com/${{ secrets.REGISTRY_NAME }}/backend-api:${{ github.sha }} .

    # --- PHASE 3: DEPLOYMENT (LOCKED: Only Runs on Merge) ---
    
    - name: Push image to DigitalOcean Container Registry
      if: github.event_name == 'push'  # <--- ONLY ON MERGE
      run: docker push registry.digitalocean.com/${{ secrets.REGISTRY_NAME }}/backend-api:${{ github.sha }}

    - name: Update Kubernetes deployment
      if: github.event_name == 'push'  # <--- ONLY ON MERGE
      run: |
        doctl kubernetes cluster kubeconfig save ${{ secrets.CLUSTER_NAME }}
        
        # Update the image
        kubectl set image deployment/backend-api backend-api=registry.digitalocean.com/${{ secrets.REGISTRY_NAME }}/backend-api:${{ github.sha }}
        
        # Watch the rollout (Zero Downtime check)
        kubectl rollout status deployment/backend-api
