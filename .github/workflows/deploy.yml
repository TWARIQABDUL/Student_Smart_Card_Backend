name: Build and Deploy to DigitalOcean K8s

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DO_ACCESS_TOKEN }}

    - name: Log in to DigitalOcean Container Registry
      run: doctl registry login --expiry-seconds 600

    - name: Build container image
      # CHANGED: 'backend-app' -> 'backend-api' to match your deployment
      run: docker build -t registry.digitalocean.com/${{ secrets.REGISTRY_NAME }}/backend-api:${{ github.sha }} .

    - name: Push image to DigitalOcean Container Registry
      # CHANGED: 'backend-app' -> 'backend-api' 
      run: docker push registry.digitalocean.com/${{ secrets.REGISTRY_NAME }}/backend-api:${{ github.sha }}

    - name: Update Kubernetes deployment
      run: |
        doctl kubernetes cluster kubeconfig save ${{ secrets.CLUSTER_NAME }}
        
        # CHANGED: deployment/backend-deployment -> deployment/backend-api
        # CHANGED: backend-container -> backend-api
        kubectl set image deployment/backend-api backend-api=registry.digitalocean.com/${{ secrets.REGISTRY_NAME }}/backend-api:${{ github.sha }}
        
        kubectl rollout status deployment/backend-api
